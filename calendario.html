<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="stylesheet" href="responsive.css" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calendario</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background-image: url('Fondo-index.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    nav {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.7);
      padding: 10px 20px;
      border-radius: 20px;
      z-index: 9999;
    }
    nav a {
      margin: 0 10px;
      text-decoration: none;
      color: #b35b8c;
      font-weight: 600;
    }
    .calendario {
      background-color: #f8d4f0;
      padding: 20px 40px;
      border-radius: 25px;
      text-align: center;
      color: #b35b8c;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      opacity: 0.9;
    }
    h1 {
      margin-bottom: 20px;
      font-size: 2em;
    }
    .navegacion {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .flecha {
      font-size: 1.5em;
      cursor: pointer;
      user-select: none;
      color: #f498c2;
      opacity: 0.6;
    }
    .mes-actual {
      font-size: 1.3em;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      width: 14.28%;
      padding: 10px;
      border-radius: 10px;
      opacity: 0.9;
      text-align: center;
    }
    th {
      color: #fff;
      background-color: #f9a8d4;
    }
    td {
      background-color: #fff;
      cursor: pointer;
    }
    td:hover {
      background-color: #fbcfe8;
    }
    .dia-ocupado {
      background-color: #ccc !important;
      color: #888;
      pointer-events: none;
    }
    .dia-pasado {
      background-color: #eee !important;
      color: #aaa;
      pointer-events: none;
    }
  </style>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDqC_XW-S9z7kTOodf01oi9xCYdbmVVtm0",
      authDomain: "orisualisados.firebaseapp.com",
      projectId: "orisualisados",
      storageBucket: "orisualisados.firebasestorage.app",
      messagingSenderId: "626633649536",
      appId: "1:626633649536:web:cb97b044ee0521d9462565",
      measurementId: "G-XBW4NQJFQD"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const mesActualTexto = document.getElementById('mesActual');
    const cuerpoCalendario = document.getElementById('cuerpoCalendario');
    let fecha = new Date();

    const HORARIOS_REQUERIDOS = ["9:00", "9:30", "13:00", "13:30"];

    async function mostrarCalendario(fecha) {
      const año = fecha.getFullYear();
      const mes = fecha.getMonth();
      const primerDia = new Date(año, mes, 1);
      const ultimoDia = new Date(año, mes + 1, 0);
      const diasMes = ultimoDia.getDate();
      const diaInicio = primerDia.getDay() === 0 ? 6 : primerDia.getDay() - 1;

      mesActualTexto.textContent = fecha.toLocaleDateString('es-ES', {
        month: 'long',
        year: 'numeric'
      });

      cuerpoCalendario.innerHTML = '';

      // Obtener todas las reservas desde Firebase
      let reservas = [];
      try {
        const snapshot = await getDocs(collection(db, "reservas"));
        snapshot.forEach(doc => reservas.push(doc.data()));
      } catch (error) {
        console.error("Error al cargar reservas desde Firebase:", error);
      }

      // Agrupar reservas por fecha
      const diasOcupados = {};
      reservas.forEach(reserva => {
        const mesFormateado = String(reserva.mes).padStart(2, '0');
        const diaFormateado = String(reserva.dia).padStart(2, '0');
        const clave = `${reserva.año}-${mesFormateado}-${diaFormateado}`;
        if (!diasOcupados[clave]) diasOcupados[clave] = [];
        diasOcupados[clave].push(reserva.hora);
      });

      let fila = document.createElement('tr');
      for (let i = 0; i < diaInicio; i++) {
        fila.innerHTML += '<td></td>';
      }

      for (let dia = 1; dia <= diasMes; dia++) {
        if (fila.children.length === 7) {
          cuerpoCalendario.appendChild(fila);
          fila = document.createElement('tr');
        }

        const mesTexto = String(mes + 1).padStart(2, '0');
        const diaTexto = String(dia).padStart(2, '0');
        const claveFecha = `${año}-${mesTexto}-${diaTexto}`;
        const horasReservadas = diasOcupados[claveFecha] || [];
        const diaCompleto = HORARIOS_REQUERIDOS.every(hora => horasReservadas.includes(hora));

        const fechaActual = new Date();
        const fechaDelDia = new Date(año, mes, dia);
        fechaDelDia.setHours(0, 0, 0, 0);
        fechaActual.setHours(0, 0, 0, 0);

        let clase = '';
        let contenido = '';
        if (fechaDelDia < fechaActual) {
          clase = 'dia-pasado';
        } else if (diaCompleto) {
          clase = 'dia-ocupado';
        }

        if (clase === '') {
          contenido = `onclick="window.location.href='horario.html?dia=${dia}&mes=${mesTexto}&año=${año}'"`;
        }

        fila.innerHTML += `<td class="${clase}" ${contenido}>${dia}</td>`;
      }

      cuerpoCalendario.appendChild(fila);
    }

    function cambiarMes(valor) {
      fecha.setMonth(fecha.getMonth() + valor);
      mostrarCalendario(fecha);
    }

    window.cambiarMes = cambiarMes;
    window.addEventListener("DOMContentLoaded", () => {
      mostrarCalendario(fecha);
    });
  </script>
</head>
<body>
  <nav>
    <a href="index.html">Inicio</a>
    <a href="calendario.html">Reservar</a>
    <a href="informacion.html">Información</a>
    <a href="lista-reservas.html">Reservas</a>
  </nav>

  <div class="calendario">
    <h1>Elige tu Fecha</h1>
    <div class="navegacion">
      <div class="flecha" onclick="cambiarMes(-1)">⬅️</div>
      <div class="mes-actual" id="mesActual"></div>
      <div class="flecha" onclick="cambiarMes(1)">➡️</div>
    </div>
    <table id="tablaCalendario">
      <thead>
        <tr>
          <th>L</th><th>M</th><th>X</th><th>J</th><th>V</th><th>S</th><th>D</th>
        </tr>
      </thead>
      <tbody id="cuerpoCalendario"></tbody>
    </table>
  </div>
</body>
</html>
